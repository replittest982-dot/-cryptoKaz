<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScarFace Hub</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #050505; 
            --card: #141414; 
            --gold: #FFD700; 
            --gold-shadow: #b39700;
            --text: #ffffff; 
            --green: #10b981; 
            --red: #ef4444;
            --gray: #6b7280;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: 'Montserrat', sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            user-select: none;
        }

        /* === LOADER === */
        #loader { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            transition: opacity 0.5s;
        }
        .spinner { 
            width: 50px; height: 50px; 
            border: 4px solid #222; border-top: 4px solid var(--gold); 
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* === HEADER === */
        .header { 
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            background: #0a0a0a; border-bottom: 1px solid #222; z-index: 50;
        }
        .logo { font-weight: 900; font-style: italic; font-size: 18px; letter-spacing: -0.5px; }
        .logo span { color: var(--gold); }
        .balance-pill { 
            background: #1a1a1a; padding: 6px 12px; border-radius: 20px; 
            font-weight: 700; font-size: 14px; color: var(--gold); 
            border: 1px solid #333; display: flex; align-items: center; gap: 5px;
        }

        /* === PAGES SYSTEM === */
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 80px; position: relative; }
        .page { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === HUB (HOME) === */
        .section-header h2 { margin: 0 0 5px 0; font-size: 24px; }
        .section-header p { margin: 0 0 20px 0; color: var(--gray); font-size: 13px; }

        .game-card { 
            background: linear-gradient(145deg, #1a1a1a, #0f0f0f); 
            border-radius: 16px; padding: 15px; margin-bottom: 15px; 
            border: 1px solid #222; display: flex; align-items: center; gap: 15px;
            position: relative; transition: transform 0.1s;
        }
        .game-card:active { transform: scale(0.98); background: #222; }
        .game-icon { font-size: 32px; width: 50px; text-align: center; }
        .game-info h3 { margin: 0; font-size: 16px; font-weight: 800; }
        .game-info p { margin: 3px 0 0; font-size: 11px; color: var(--gray); }
        .status-badge { 
            position: absolute; top: 10px; right: 10px; 
            font-size: 10px; padding: 3px 8px; border-radius: 6px; 
            font-weight: 800; letter-spacing: 0.5px;
        }
        .live { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.2); }
        .soon { background: rgba(255, 255, 255, 0.05); color: var(--gray); border: 1px solid #333; }

        /* === CRASH GAME === */
        .crash-wrapper { 
            position: relative; height: 280px; 
            background: radial-gradient(circle at 50% 100%, #222 0%, #000 70%); 
            border-radius: 20px; overflow: hidden; margin-bottom: 15px; border: 1px solid #222;
        }
        #crashCanvas { width: 100%; height: 100%; }
        .center-overlay { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; 
        }
        #multiplier { font-size: 60px; font-weight: 900; text-shadow: 0 0 30px rgba(0,0,0,0.8); }
        #multiplier.crashed { color: var(--red); }
        #game-status { font-size: 12px; font-weight: 700; color: var(--gray); letter-spacing: 2px; margin-top: 5px; }

        /* CONTROLS */
        .controls-box { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid #222; }
        
        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .input-wrapper { 
            flex: 1; background: #000; border: 1px solid #333; border-radius: 12px; 
            display: flex; align-items: center; padding: 0 15px; 
        }
        .bet-input { 
            width: 100%; background: none; border: none; color: white; 
            font-size: 18px; font-weight: 700; text-align: center; padding: 12px 0; 
            font-family: 'Montserrat', sans-serif;
        }
        .adj-btn { 
            width: 50px; background: #222; border: 1px solid #333; color: white; 
            border-radius: 12px; font-size: 20px; font-weight: bold; 
        }

        .action-btn { 
            width: 100%; height: 55px; border: none; border-radius: 14px; 
            font-size: 18px; font-weight: 800; cursor: pointer; transition: 0.1s; 
        }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 4px 0 var(--gold-shadow); }
        .btn-green { background: var(--green); color: white; box-shadow: 0 4px 0 #047857; }
        .btn-gray { background: #222; color: #555; pointer-events: none; }
        .btn-gold:active, .btn-green:active { transform: translateY(4px); box-shadow: none; }

        /* PLAYERS LIST */
        .players-list { margin-top: 20px; font-size: 13px; }
        .p-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #222; color: #aaa; }
        .p-win { color: var(--green); font-weight: bold; }

        /* === REFERRAL === */
        .ref-card { 
            background: var(--card); padding: 30px 20px; border-radius: 20px; 
            text-align: center; border: 1px solid #222; margin-top: 20px;
        }
        .ref-link-box { 
            background: #000; padding: 15px; border-radius: 10px; 
            font-family: monospace; color: var(--gold); margin: 20px 0; 
            word-break: break-all; font-size: 12px; border: 1px dashed #333; 
        }

        /* === NAV BAR === */
        .nav-bar { 
            position: fixed; bottom: 0; width: 100%; height: 70px; 
            background: #0a0a0a; border-top: 1px solid #222; 
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item { 
            display: flex; flex-direction: column; align-items: center; gap: 4px; 
            font-size: 10px; font-weight: 700; color: #444; transition: 0.2s; 
        }
        .nav-item.active { color: var(--gold); transform: translateY(-2px); }
        .nav-icon { font-size: 24px; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-size:12px; color:#666;">Connecting to ScarFace Server...</div>
    </div>

    <div class="header">
        <div class="logo">ScarFace<span>Team</span></div>
        <div class="balance-pill">üíé <span id="balance">...</span></div>
    </div>

    <div class="content-area">
        
        <div id="page-hub" class="page active">
            <div class="section-header">
                <h2>Game Hub</h2>
                <p>–í—ã–±–µ—Ä–∏ –∏–≥—Ä—É –∏ –ø–æ–±–µ–∂–¥–∞–π</p>
            </div>

            <div class="game-card" onclick="navTo('page-crash')">
                <div class="game-icon">üöÄ</div>
                <div class="game-info" style="flex:1">
                    <h3>Epic Crash</h3>
                    <p>–ü–æ–π–º–∞–π –∏–∫—Å—ã –¥–æ –≤–∑—Ä—ã–≤–∞</p>
                </div>
                <div class="status-badge live">LIVE</div>
            </div>

            <div class="game-card" style="opacity: 0.6;">
                <div class="game-icon">üé≤</div>
                <div class="game-info" style="flex:1">
                    <h3>Board Game</h3>
                    <p>–ö–∏–¥–∞–π –∫—É–±–∏–∫–∏ (–°–∫–æ—Ä–æ)</p>
                </div>
                <div class="status-badge soon">SOON</div>
            </div>

            <div class="game-card" style="opacity: 0.6;">
                <div class="game-icon">üé∞</div>
                <div class="game-info" style="flex:1">
                    <h3>Casino</h3>
                    <p>Classic Slots (Dev)</p>
                </div>
                <div class="status-badge soon">DEV</div>
            </div>
        </div>

        <div id="page-crash" class="page">
            <button onclick="navTo('page-hub')" style="background:none; border:none; color:#666; font-weight:bold; margin-bottom:10px;">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
            
            <div class="crash-wrapper">
                <canvas id="crashCanvas"></canvas>
                <div class="center-overlay">
                    <div id="multiplier">1.00x</div>
                    <div id="game-status">–û–ñ–ò–î–ê–ù–ò–ï</div>
                </div>
            </div>

            <div class="controls-box">
                <div class="input-row">
                    <button class="adj-btn" onclick="adjBet(-10)">-</button>
                    <div class="input-wrapper">
                        <input type="number" id="betInput" class="bet-input" value="10" step="0.1" min="0.1">
                    </div>
                    <button class="adj-btn" onclick="adjBet(10)">+</button>
                </div>
                <button id="mainBtn" class="action-btn btn-gold" onclick="doAction()">–ü–û–°–¢–ê–í–ò–¢–¨</button>
            </div>

            <div class="players-list" id="playersList">
                </div>
        </div>

        <div id="page-earn" class="page">
            <div class="ref-card">
                <div style="font-size:40px; margin-bottom:15px">ü§ù</div>
                <h2>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
                <p style="color:#888; font-size:13px; margin-top:10px;">
                    –ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π <b style="color:var(--gold)">0.5%</b> –æ—Ç –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ.
                </p>
                <div class="ref-link-box" id="refLink">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–∫–∏...</div>
                <button class="action-btn btn-gold" onclick="copyRef()">–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
            </div>
        </div>

    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navTo('page-hub', this)">
            <span class="nav-icon">üè†</span>Hub
        </div>
        <div class="nav-item" onclick="navTo('page-earn', this)">
            <span class="nav-icon">üí∏</span>Earn
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –¢–≤–æ–π URL Bothost
        const SERVER_URL = "https://bot_1766306473_1270_metropabg189-gmail-c.bothost.ru"; 
        
        // 1. –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï (Polling –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
        const socket = io(SERVER_URL, { 
            transports: ['polling', 'websocket'], 
            reconnectionAttempts: 20
        });

        // –î–∞–Ω–Ω—ã–µ
        let user = { id: new URLSearchParams(window.location.search).get('user_id'), bal: 0 };
        let game = { status: 'WAITING', m: 1.0, myBet: 0, inGame: false };

        // --- SOCKET HANDLERS ---
        
        socket.on('connect', () => {
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
            socket.emit('auth', { user_id: user.id });
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É (–∑–∞–º–µ–Ω–∏ CryptoKazBot –Ω–∞ —Å–≤–æ–π —é–∑–µ—Ä–Ω–µ–π–º –µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)
            document.getElementById('refLink').innerText = `https://t.me/CryptoKazBot?start=${user.id}`;
        });

        socket.on('balance', val => {
            user.bal = val;
            document.getElementById('balance').innerText = val.toFixed(1);
        });

        socket.on('game_update', d => {
            game.status = d.status;
            renderPlayers(d.players || []);
            if(game.status === 'WAITING') {
                game.inGame = false;
                resetGameUI();
            }
            updateBtn();
        });

        socket.on('tick', m => {
            game.status = 'FLYING';
            game.m = m;
            document.getElementById('multiplier').innerText = m.toFixed(2) + 'x';
            document.getElementById('multiplier').classList.remove('crashed');
            document.getElementById('game-status').innerText = "–ü–û–õ–ï–¢...";
            updateBtn();
            drawRocket(m);
        });

        socket.on('crash', d => {
            game.status = 'CRASHED';
            document.getElementById('multiplier').innerText = d.m.toFixed(2) + 'x';
            document.getElementById('multiplier').classList.add('crashed');
            document.getElementById('game-status').innerText = "–ö–†–ê–®";
            tg.HapticFeedback.notificationOccurred('error');
            updateBtn();
        });

        socket.on('bet_ok', () => {
            game.inGame = true;
            game.myBet = parseFloat(document.getElementById('betInput').value);
            tg.HapticFeedback.impactOccurred('medium');
            updateBtn();
        });

        socket.on('win', (amt) => {
            game.inGame = false;
            tg.HapticFeedback.notificationOccurred('success');
            updateBtn();
        });
        
        socket.on('players_update', renderPlayers);

        // --- –õ–û–ì–ò–ö–ê UI ---
        
        function navTo(pageId, navEl) {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –º–µ–Ω—é
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }
        }

        function adjBet(val) {
            let input = document.getElementById('betInput');
            let current = parseFloat(input.value) || 0;
            let res = Math.max(0.1, current + val);
            input.value = res.toFixed(1);
        }

        function doAction() {
            let betVal = parseFloat(document.getElementById('betInput').value);
            
            if(game.status === 'WAITING') {
                if(!game.inGame) {
                    if(betVal > 0 && betVal <= user.bal) {
                        socket.emit('place_bet', betVal);
                    } else {
                        tg.HapticFeedback.notificationOccurred('warning');
                    }
                }
            } else if(game.status === 'FLYING' && game.inGame) {
                socket.emit('cash_out');
            }
        }

        function updateBtn() {
            let btn = document.getElementById('mainBtn');
            if(game.status === 'WAITING') {
                if(game.inGame) {
                    btn.className = "action-btn btn-gray";
                    btn.innerText = "–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê";
                } else {
                    btn.className = "action-btn btn-gold";
                    btn.innerText = "–ü–û–°–¢–ê–í–ò–¢–¨";
                }
            } else if(game.status === 'FLYING') {
                if(game.inGame) {
                    btn.className = "action-btn btn-green";
                    btn.innerText = `–ó–ê–ë–†–ê–¢–¨ ${(game.myBet * game.m).toFixed(1)}`;
                } else {
                    btn.className = "action-btn btn-gray";
                    btn.innerText = "–ò–î–ï–¢ –†–ê–£–ù–î...";
                }
            } else {
                btn.className = "action-btn btn-gray";
                btn.innerText = "–ö–†–ê–®";
            }
        }

        function resetGameUI() {
            document.getElementById('multiplier').innerText = "1.00x";
            document.getElementById('multiplier').classList.remove('crashed');
            document.getElementById('game-status').innerText = "–û–ñ–ò–î–ê–ù–ò–ï";
            ctx.clearRect(0,0,canvas.width,canvas.height);
            updateBtn();
        }

        function renderPlayers(list) {
            let html = list.map(p => `
                <div class="p-row">
                    <span>ID ${p.uid}</span>
                    <span class="${p.win > 0 ? 'p-win' : ''}">
                        ${p.win > 0 ? '+' + p.win.toFixed(1) : p.bet.toFixed(1)}
                    </span>
                </div>
            `).join('');
            document.getElementById('playersList').innerHTML = html;
        }

        function copyRef() {
            let txt = document.getElementById('refLink').innerText;
            navigator.clipboard.writeText(txt);
            tg.ShowPopup({message: "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"});
        }

        // --- –ì–†–ê–§–ò–ö–ê –†–ê–ö–ï–¢–´ ---
        const canvas = document.getElementById('crashCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resize); resize();

        function drawRocket(m) {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            let w = canvas.width, h = canvas.height;
            
            // –ö—Ä–∏–≤–∞—è
            let p = Math.min((m-1)/5, 1); 
            let x = 40 + (w-80)*p;
            let y = (h-40) - (h-80)*Math.sqrt(p);
            
            // –õ–∏–Ω–∏—è
            ctx.beginPath();
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 4;
            ctx.shadowBlur = 10; ctx.shadowColor = '#FFD700';
            ctx.moveTo(40, h-40);
            ctx.quadraticCurveTo(w/2, h-40, x, y);
            ctx.stroke();
            ctx.shadowBlur = 0;
            
            // –†–∞–∫–µ—Ç–∞
            ctx.font = "30px Arial"; 
            ctx.fillText("üöÄ", x-15, y);
        }
    </script>
</body>
</html>
