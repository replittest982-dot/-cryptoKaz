<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Kaz Live</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #0f1923; color: white; font-family: 'Arial', sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* –ò–≥—Ä–æ–≤–∞—è –∑–æ–Ω–∞ */
        .game-area {
            position: relative;
            flex-grow: 1;
            background: radial-gradient(circle at bottom left, #1c252e, #000000);
            border-bottom: 2px solid #2c3e50;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* –¢–µ–∫—Å—Ç –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .center-hud {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .multiplier { font-size: 64px; font-weight: 900; text-shadow: 0 0 25px rgba(46, 204, 113, 0.5); color: white; }
        .crashed { color: #e74c3c; text-shadow: 0 0 25px rgba(231, 76, 60, 0.5); }
        .status-text { font-size: 18px; color: #7f8c8d; margin-top: 5px; }

        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
        .controls { padding: 15px; background: #151e27; z-index: 10; }
        
        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-bar { display: flex; gap: 6px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 5px; height: 28px; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; flex-shrink: 0; background: #2c3e50; color: #bdc3c7; }
        .badge.win { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .badge.lose { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }

        /* –°—Ç–∞–≤–∫–∏ */
        .bet-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .input-box { flex: 1; background: #0f1923; border: 1px solid #34495e; border-radius: 8px; color: white; padding: 12px; text-align: center; font-size: 18px; font-weight: bold; }
        .adj-btn { width: 45px; height: 45px; background: #2c3e50; border: none; border-radius: 8px; color: white; font-size: 20px; font-weight: bold; }
        
        /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        .main-btn {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-size: 20px; font-weight: 900; color: white; transition: 0.1s;
            text-transform: uppercase;
        }
        .btn-green { background: #27ae60; box-shadow: 0 4px 0 #219150; }
        .btn-green:active { transform: translateY(2px); box-shadow: none; }
        .btn-orange { background: #e67e22; box-shadow: 0 4px 0 #d35400; }
        .btn-grey { background: #34495e; color: #7f8c8d; pointer-events: none; }

        .top-info { display: flex; justify-content: space-between; font-size: 14px; color: #bdc3c7; margin-bottom: 5px; font-weight: bold; }
        .balance-val { color: #2ecc71; }
    </style>
</head>
<body>

    <div class="game-area">
        <canvas id="gameCanvas"></canvas>
        <div class="center-hud">
            <div id="mText" class="multiplier">1.00x</div>
            <div id="statusText" class="status-text">Connecting...</div>
        </div>
    </div>

    <div class="controls">
        <div class="top-info">
            <span>BALANCE: <span id="balanceText" class="balance-val">0</span></span>
            <span id="connStatus">üî¥ Offline</span>
        </div>

        <div class="history-bar" id="historyContainer"></div>

        <div class="bet-row">
            <button class="adj-btn" onclick="adjBet(-50)">-</button>
            <input type="number" id="betInput" class="input-box" value="100" readonly>
            <button class="adj-btn" onclick="adjBet(50)">+</button>
        </div>

        <button id="actionBtn" class="main-btn btn-grey" onclick="handleAction()">LOADING...</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –¢–í–û–ï–ú–£ –î–û–ú–ï–ù–£ ===
        const SERVER_URL = "https://kazcryptoscarface.com";
        
        const socket = io(SERVER_URL, { 
            transports: ['websocket', 'polling'], // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∫–µ—Ç—ã
            reconnection: true 
        });

        // –î–∞–Ω–Ω—ã–µ
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        let gameState = "WAITING";
        let isBetting = false;
        let myBetAmount = 0;
        let canvas, ctx, W, H;

        // UI –≠–ª–µ–º–µ–Ω—Ç—ã
        const elM = document.getElementById('mText');
        const elStatus = document.getElementById('statusText');
        const elBtn = document.getElementById('actionBtn');
        const elBal = document.getElementById('balanceText');
        const elConn = document.getElementById('connStatus');
        const elHist = document.getElementById('historyContainer');

        initCanvas();

        // === –°–û–ö–ï–¢–´ ===
        socket.on('connect', () => {
            elConn.innerText = "üü¢ Online";
            if(userId) socket.emit('auth', { user_id: userId });
        });

        socket.on('disconnect', () => {
            elConn.innerText = "üî¥ Offline";
        });

        socket.on('balance', (bal) => {
            elBal.innerText = bal;
            tg.HapticFeedback.selectionChanged();
        });

        socket.on('game_update', (data) => {
            gameState = data.status;
            renderHistory(data.history);
            updateUI();
        });

        socket.on('tick', (m) => {
            gameState = "FLYING";
            elM.innerText = m.toFixed(2) + "x";
            
            if (isBetting) {
                const win = Math.floor(myBetAmount * m);
                elBtn.className = "main-btn btn-orange";
                elBtn.innerText = `CASHOUT (${win})`;
            }
            
            drawRocket(m);
        });

        socket.on('crash', (data) => {
            gameState = "CRASHED";
            elM.innerText = "CRASH " + data.m.toFixed(2) + "x";
            elM.classList.add("crashed");
            
            elBtn.className = "main-btn btn-grey";
            elBtn.innerText = "–í–ó–û–†–í–ê–õ–°–Ø";
            
            if(isBetting) {
                tg.HapticFeedback.notificationOccurred('error');
                isBetting = false;
            }
            updateUI();
        });

        socket.on('bet_ok', (amt) => {
            isBetting = true;
            myBetAmount = amt;
            updateUI();
        });

        socket.on('win', (amt) => {
            isBetting = false;
            tg.HapticFeedback.notificationOccurred('success');
            // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Å–∏–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é —Ç—É—Ç
            alert(`–ü–û–ë–ï–î–ê! +${amt}`);
            updateUI();
        });

        // === –õ–û–ì–ò–ö–ê ===
        function handleAction() {
            if (gameState === "WAITING" && !isBetting) {
                const val = parseInt(document.getElementById('betInput').value);
                socket.emit('place_bet', val);
            } else if (gameState === "FLYING" && isBetting) {
                socket.emit('cash_out');
            }
        }

        function updateUI() {
            if (gameState === "WAITING") {
                elM.classList.remove("crashed");
                elM.innerText = "1.00x";
                elStatus.innerText = "–ü—Ä–∏–µ–º —Å—Ç–∞–≤–æ–∫...";
                drawRocket(1.0);
                
                if (isBetting) {
                    elBtn.className = "main-btn btn-grey";
                    elBtn.innerText = "–°–¢–ê–í–ö–ê –ü–†–ò–ù–Ø–¢–ê";
                } else {
                    elBtn.className = "main-btn btn-green";
                    elBtn.innerText = "–ü–û–°–¢–ê–í–ò–¢–¨";
                }
            }
        }

        function renderHistory(hist) {
            elHist.innerHTML = "";
            hist.forEach(val => {
                const d = document.createElement('div');
                d.className = val >= 2.0 ? "badge win" : "badge lose";
                d.innerText = val.toFixed(2) + "x";
                elHist.appendChild(d);
            });
        }

        function adjBet(n) {
            const el = document.getElementById('betInput');
            let v = parseInt(el.value) + n;
            if (v >= 50) el.value = v;
        }

        // === –†–ò–°–û–í–ê–ù–ò–ï ===
        function initCanvas() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);
        }
        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            W = canvas.width; H = canvas.height;
        }

        function drawRocket(m) {
            ctx.clearRect(0, 0, W, H);
            
            // –°–µ—Ç–∫–∞
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<W; i+=60) { ctx.moveTo(i,0); ctx.lineTo(i,H); }
            for(let i=0; i<H; i+=60) { ctx.moveTo(0,i); ctx.lineTo(W,i); }
            ctx.stroke();

            // –¢—Ä–∞–µ–∫—Ç–æ—Ä–∏—è
            let progress = (m - 1) / 4; 
            if (progress > 0.9) progress = 0.9;

            let x = 40 + (W - 80) * progress;
            let y = (H - 40) - (H - 80) * progress;

            ctx.strokeStyle = "#2ecc71";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(40, H-40);
            ctx.quadraticCurveTo(x, H-40, x, y);
            ctx.stroke();

            // –†–∞–∫–µ—Ç–∞
            ctx.save();
            ctx.translate(x, y);
            ctx.font = "36px Arial";
            ctx.fillText("üöÄ", -20, 10);
            
            // –ß–∞—Å—Ç–∏—Ü—ã
            ctx.fillStyle = "rgba(230, 126, 34, 0.8)";
            ctx.beginPath();
            ctx.arc(-25, 15, 6 + Math.random()*4, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
        }
    </script>
</body>
</html>
