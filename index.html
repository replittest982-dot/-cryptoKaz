<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScarFaceTeam</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #050505; 
            --card: #141414; 
            --primary: #FFD700; 
            --danger: #ff3b30;
            --success: #34c759;
            --text: #ffffff;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(20,20,20,0.9); }
        .logo { font-weight: 900; font-style: italic; font-size: 18px; }
        .balance { background: #333; padding: 5px 12px; border-radius: 12px; font-weight: bold; color: var(--primary); }

        /* SCREENS */
        .screen { display: none; flex: 1; flex-direction: column; overflow-y: auto; padding-bottom: 70px; }
        .screen.active { display: flex; }

        /* CRASH GAME */
        .game-viz { position: relative; height: 280px; background: radial-gradient(circle at bottom, #2a2a2a 0%, #000 70%); }
        #canvas { width: 100%; height: 100%; }
        .multiplier { position: absolute; top: 40%; left: 50%; transform: translate(-50%,-50%); font-size: 64px; font-weight: 900; }
        .multiplier.crash { color: var(--danger); }
        
        .controls { padding: 15px; background: var(--card); border-radius: 20px 20px 0 0; margin-top: -20px; z-index: 10; }
        .main-btn { width: 100%; height: 55px; border: none; border-radius: 14px; font-size: 20px; font-weight: 800; cursor: pointer; transition: 0.1s; }
        .btn-bet { background: var(--primary); color: #000; box-shadow: 0 4px 0 #b39700; }
        .btn-cash { background: var(--success); color: #fff; box-shadow: 0 4px 0 #248a3d; }
        .btn-dis { background: #333; color: #777; pointer-events: none; }
        .btn-bet:active, .btn-cash:active { transform: translateY(4px); box-shadow: none; }

        .players-title { font-size: 12px; color: #777; margin: 15px 15px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .player-row { display: flex; justify-content: space-between; padding: 8px 15px; border-bottom: 1px solid #222; font-size: 14px; }
        .win-amt { color: var(--success); font-weight: bold; }

        /* REFERRAL */
        .ref-box { margin: 20px; padding: 20px; background: var(--card); border-radius: 16px; text-align: center; border: 1px solid #333; }
        .ref-link-box { background: #000; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; color: var(--primary); word-break: break-all; margin: 10px 0; }

        /* NAV */
        .nav { position: fixed; bottom: 0; width: 100%; height: 60px; background: #111; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { color: #555; font-size: 10px; font-weight: bold; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* DEBUG */
        #debug-log { position: absolute; top:0; left:0; width:100%; background:rgba(255,0,0,0.8); color:white; font-size:10px; display:none; z-index:9999; padding:5px; }
    </style>
</head>
<body>
    <div id="debug-log"></div>

    <div class="header">
        <div class="logo">ScarFace<span style="color:var(--primary)">Team</span></div>
        <div class="balance">üíé <span id="balance">...</span></div>
    </div>

    <div id="home" class="screen active">
        <div class="game-viz">
            <canvas id="canvas"></canvas>
            <div class="multiplier" id="multi">1.00x</div>
        </div>
        <div class="controls">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#aaa; font-size:12px;">
                <span>Bet Amount</span>
                <span>Max: 1000</span>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button onclick="adjBet(-50)" style="padding:10px; background:#222; color:white; border:none; border-radius:8px;">-50</button>
                <div style="flex:1; background:#000; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px;" id="bet-val">100</div>
                <button onclick="adjBet(50)" style="padding:10px; background:#222; color:white; border:none; border-radius:8px;">+50</button>
            </div>
            <button id="actionBtn" class="main-btn btn-bet" onclick="doAction()">BET</button>
        </div>
        
        <div class="players-title">Live Players (Real Only)</div>
        <div id="players-list"></div>
    </div>

    <div id="referral" class="screen">
        <div class="ref-box">
            <div style="font-size:40px; margin-bottom:10px;">ü§ù</div>
            <h3>Invite Friends</h3>
            <p style="color:#aaa; font-size:13px;">Earn <b>0.5%</b> from every deposit your friends make.</p>
            <div class="ref-link-box" id="my-ref-link">Loading...</div>
            <button onclick="copyRef()" style="background:var(--primary); border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">COPY LINK</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('home', this)">
            <span class="icon">üè†</span> HOME
        </div>
        <div class="nav-item" onclick="switchTab('referral', this)">
            <span class="icon">üë•</span> REFERRAL
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // üî• –í–û–¢ –¢–í–û–Ø –°–°–´–õ–ö–ê, –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–ê üî•
        const SERVER_URL = "https://bot_1766306473_1270_metropabg189-gmail-c.bothost.ru"; 
        
        // –ü–æ–ª—É—á–∞–µ–º User ID
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id;

        // DEBUG LOGGING
        function log(msg) {
            const el = document.getElementById('debug-log');
            el.style.display = 'block';
            el.innerText = msg;
        }

        if (!userId) log("Warning: User ID not found. Open from Bot.");

        // SOCKET
        const socket = io(SERVER_URL, { 
            transports: ['websocket', 'polling'], // –ü—Ä–æ–±—É–µ–º –æ–±–∞ –º–µ—Ç–æ–¥–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            reconnectionAttempts: 10
        });

        socket.on('connect_error', (err) => {
            log("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + err.message + " (" + SERVER_URL + ")");
        });

        // STATE
        let state = { status: 'WAITING', m: 1.0, myBet: 0, inGame: false };
        let currentBetAmt = 100;

        // AUTH
        socket.on('connect', () => {
            document.getElementById('debug-log').style.display = 'none';
            socket.emit('auth', { user_id: userId });
            
            // Generate Ref Link (–ó–∞–º–µ–Ω–∏ YourBotName –Ω–∞ –∏–º—è –±–æ—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            document.getElementById('my-ref-link').innerText = `https://t.me/YourBotName?start=${userId}`;
        });

        socket.on('balance', (b) => document.getElementById('balance').innerText = b);

        socket.on('game_update', (d) => {
            state.status = d.status;
            renderPlayers(d.players);
            if(state.status === 'WAITING') {
                resetGameUI();
            }
        });

        socket.on('tick', (m) => {
            state.status = 'FLYING';
            state.m = m;
            document.getElementById('multi').innerText = m.toFixed(2) + 'x';
            updateBtn();
            drawRocket(m); // –†–∏—Å—É–µ–º –∫–∞–∂–¥—ã–π —Ç–∏–∫
        });

        socket.on('crash', (d) => {
            state.status = 'CRASHED';
            document.getElementById('multi').innerText = d.m.toFixed(2) + 'x';
            document.getElementById('multi').classList.add('crash');
            tg.HapticFeedback.notificationOccurred('error');
            updateBtn();
        });

        socket.on('bet_ok', () => {
            state.inGame = true;
            state.myBet = currentBetAmt;
            tg.HapticFeedback.impactOccurred('medium');
            updateBtn();
        });

        socket.on('win', (amt) => {
            state.inGame = false;
            tg.HapticFeedback.notificationOccurred('success');
            updateBtn();
        });

        socket.on('players_update', (list) => {
            renderPlayers(list);
        });

        // UI LOGIC
        function switchTab(tab, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function adjBet(val) {
            currentBetAmt = Math.max(50, currentBetAmt + val);
            document.getElementById('bet-val').innerText = currentBetAmt;
        }

        function doAction() {
            if (state.status === 'WAITING' && !state.inGame) {
                socket.emit('place_bet', currentBetAmt);
            } else if (state.status === 'FLYING' && state.inGame) {
                socket.emit('cash_out');
            }
        }

        function updateBtn() {
            const btn = document.getElementById('actionBtn');
            if (state.status === 'WAITING') {
                if (state.inGame) {
                    btn.className = "main-btn btn-dis";
                    btn.innerText = "BET PLACED";
                } else {
                    btn.className = "main-btn btn-bet";
                    btn.innerText = "BET";
                }
            } else if (state.status === 'FLYING') {
                if (state.inGame) {
                    btn.className = "main-btn btn-cash";
                    btn.innerText = `CASH OUT ${(state.myBet * state.m).toFixed(0)}`;
                } else {
                    btn.className = "main-btn btn-dis";
                    btn.innerText = "WAIT NEXT ROUND";
                }
            } else {
                btn.className = "main-btn btn-dis";
                btn.innerText = "CRASHED";
            }
        }

        function resetGameUI() {
            state.inGame = false;
            state.m = 1.0;
            document.getElementById('multi').innerText = "1.00x";
            document.getElementById('multi').classList.remove('crash');
            updateBtn();
            ctx.clearRect(0,0,canvas.width,canvas.height);
        }

        function renderPlayers(list) {
            const div = document.getElementById('players-list');
            if(list.length === 0) {
                div.innerHTML = '<div style="padding:15px; color:#444; text-align:center; font-size:12px;">Waiting for players...</div>';
                return;
            }
            div.innerHTML = list.map(p => `
                <div class="player-row">
                    <div>${p.uid == userId ? '<b style="color:var(--primary)">YOU</b>' : 'User ' + p.uid}</div>
                    <div>
                        ${p.win > 0 
                            ? `<span class="win-amt">+${p.win}</span>` 
                            : `<span>${p.bet}</span>`}
                    </div>
                </div>
            `).join('');
        }

        function copyRef() {
            const text = document.getElementById('my-ref-link').innerText;
            navigator.clipboard.writeText(text);
            tg.ShowPopup({message: "Link copied!"});
        }

        // CANVAS ENGINE
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        function resize() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resize); resize();

        function drawRocket(m) {
            // –û—á–∏—â–∞–µ–º
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const w = canvas.width, h = canvas.height;
            
            // –ö—Ä–∏–≤–∞—è
            let p = Math.min((m - 1) / 5, 1); 
            let x = 30 + (w - 60) * p;
            let y = (h - 30) - (h - 60) * Math.sqrt(p);
            
            ctx.beginPath();
            ctx.strokeStyle = '#FFD700'; // Gold
            ctx.lineWidth = 4;
            ctx.moveTo(30, h-30);
            ctx.quadraticCurveTo(w/2, h-30, x, y);
            ctx.stroke();
            
            // –†–∞–∫–µ—Ç–∞
            ctx.font = "30px Arial";
            ctx.fillText("üöÄ", x-15, y);
        }
    </script>
</body>
</html>
