<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Epic Crash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121214;
            --card-bg: #1d1d1f;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --text-color: #ffffff;
            --text-secondary: #9ca3af;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- HEADER --- */
        .header {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.1);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #4ade80;
        }
        .dot { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 5px #4ade80; }
        
        .balance-pill {
            background: #252528;
            padding: 6px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .diamond-icon { color: #3b82f6; font-size: 14px; }

        /* --- GAME AREA --- */
        .game-wrapper {
            position: relative;
            width: 100%;
            height: 280px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞–∫ –Ω–∞ –≤–∏–¥–µ–æ */
            background: radial-gradient(circle at bottom, #1e1e24 0%, #121214 70%);
            overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* OVERLAYS (Countdown & Multiplier) */
        .center-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }
        
        .countdown {
            font-size: 80px;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 30px rgba(255,255,255,0.2);
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
        }
        .countdown.active { animation: popIn 0.8s forwards; }

        @keyframes popIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }

        .multiplier-text {
            font-size: 48px;
            font-weight: 800;
            color: white;
            opacity: 0;
            transition: color 0.2s;
        }
        .multiplier-text.visible { opacity: 1; }
        .multiplier-text.crashed { color: #ef4444; }

        /* --- CONTROLS AREA --- */
        .controls-container {
            background: var(--bg-color);
            padding: 10px 16px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            margin-top: -20px; /* –ù–∞–µ–∑–¥ –Ω–∞ –∫–∞–Ω–≤–∞—Å */
            z-index: 20;
            position: relative;
        }

        /* HISTORY ROW */
        .history-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 5px;
        }
        .history-row::-webkit-scrollbar { display: none; }
        
        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
            background: #2a2a2c;
            color: #9ca3af;
        }
        .badge.purple { color: #c084fc; background: rgba(192, 132, 252, 0.15); }
        .badge.gold { color: #fbbf24; background: rgba(251, 191, 36, 0.15); }
        .badge.blue { color: #60a5fa; background: rgba(96, 165, 250, 0.15); }

        /* BET BUTTONS */
        .main-btn {
            width: 100%;
            height: 56px;
            border-radius: 16px;
            border: none;
            font-size: 18px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: transform 0.1s;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        .main-btn:active { transform: scale(0.98); }
        
        .btn-blue { background: #3b82f6; box-shadow: 0 4px 0 #2563eb; }
        .btn-red { background: #ef4444; box-shadow: 0 4px 0 #dc2626; }
        .btn-green { background: #10b981; box-shadow: 0 4px 0 #059669; }
        .btn-disabled { background: #374151; color: #9ca3af; box-shadow: none; pointer-events: none; }

        .bet-inputs {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-box {
            background: #1d1d1f;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 8px;
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-box span { font-size: 12px; color: #9ca3af; }
        .input-val { font-weight: bold; }

        /* --- PLAYERS LIST (FAKE) --- */
        .players-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
            background: var(--bg-color);
        }
        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }
        .player-info { display: flex; align-items: center; gap: 8px; }
        .avatar { width: 24px; height: 24px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 10px; }
        .player-bet { color: var(--text-secondary); display: flex; align-items: center; gap: 4px; }
        .player-win { color: var(--accent-green); font-weight: bold; background: rgba(16, 185, 129, 0.1); padding: 2px 6px; border-radius: 4px; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background: #18181b;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: #6b7280;
            cursor: pointer;
        }
        .nav-item.active { color: white; }
        .nav-icon { font-size: 20px; }

    </style>
</head>
<body>

    <div class="header">
        <div class="status-badge"><div class="dot"></div> Live</div>
        <div class="balance-pill">
            <span class="diamond-icon">üíé</span>
            <span id="balanceDisplay">1000.00</span>
        </div>
    </div>

    <div class="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div class="center-overlay countdown" id="cnt3">3</div>
        <div class="center-overlay countdown" id="cnt2">2</div>
        <div class="center-overlay countdown" id="cnt1">1</div>
        <div class="center-overlay multiplier-text" id="multiDisplay">1.00x</div>
    </div>

    <div class="controls-container">
        <div class="history-row" id="historyRow">
            <div class="badge purple">5.10x</div>
            <div class="badge">1.10x</div>
            <div class="badge gold">26.1x</div>
        </div>

        <div class="bet-inputs">
            <div class="input-box" onclick="changeBet(-50)">
                <span>Bet</span>
                <span class="input-val" id="betVal">100</span>
            </div>
             <div class="input-box" onclick="changeBet(50)">
                <span>+50</span>
            </div>
         </div>

        <button class="main-btn btn-blue" id="actionBtn" onclick="handleAction()">Place bet</button>
    </div>

    <div class="players-list" id="playersList">
        </div>

    <div class="bottom-nav">
        <div class="nav-item"><span class="nav-icon">üéí</span>Backpack</div>
        <div class="nav-item"><span class="nav-icon">üë•</span>Invite</div>
        <div class="nav-item active"><span class="nav-icon">üè†</span>Home</div>
        <div class="nav-item"><span class="nav-icon">üèÜ</span>Ranking</div>
        <div class="nav-item"><span class="nav-icon">üí∞</span>Earn</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- GAME VARIABLES ---
        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseFloat(urlParams.get('start_balance')) || 1000.00;
        let currentBet = 100;
        
        let gameState = 'WAITING'; // WAITING -> COUNTDOWN -> FLYING -> CRASHED
        let userBetPlaced = false;
        let multiplier = 1.00;
        let crashPoint = 0;
        let animationId;
        
        // Canvas & Assets
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        
        // Rocket Emoji (Using text for ease, can be replaced with Image)
        const ROCKET_ICON = "üöÄ"; 

        // UI Elements
        const elBalance = document.getElementById('balanceDisplay');
        const elMulti = document.getElementById('multiDisplay');
        const elBtn = document.getElementById('actionBtn');
        const elBetVal = document.getElementById('betVal');
        const elHistory = document.getElementById('historyRow');

        // Init
        resize();
        window.addEventListener('resize', resize);
        updateUI();
        generateFakePlayers(); // Populate list initially

        function resize() {
            W = canvas.width = canvas.offsetWidth;
            H = canvas.height = canvas.offsetHeight;
        }

        function updateUI() {
            elBalance.innerText = balance.toFixed(2);
            elBetVal.innerText = currentBet;
        }

        function changeBet(amount) {
            if (gameState !== 'WAITING' || userBetPlaced) return;
            let newBet = currentBet + amount;
            if (newBet >= 50 && newBet <= balance) {
                currentBet = newBet;
                updateUI();
                tg.HapticFeedback.selectionChanged();
            }
        }

        // --- BUTTON LOGIC ---
        function handleAction() {
            tg.HapticFeedback.impactOccurred('light');

            if (gameState === 'WAITING') {
                if (!userBetPlaced) {
                    // Place Bet
                    if (balance < currentBet) return tg.showAlert("No money!");
                    balance -= currentBet;
                    userBetPlaced = true;
                    updateUI();
                    
                    elBtn.className = 'main-btn btn-red';
                    elBtn.innerText = 'Cancel Bet';
                    
                    // Add user to top of fake players list
                    addSelfToPlayersList();
                } else {
                    // Cancel Bet
                    balance += currentBet;
                    userBetPlaced = false;
                    updateUI();
                    elBtn.className = 'main-btn btn-blue';
                    elBtn.innerText = 'Place bet';
                    removeSelfFromPlayers();
                }
            } 
            else if (gameState === 'FLYING' && userBetPlaced) {
                // Cash Out
                doCashOut();
            }
        }

        function doCashOut() {
            const win = currentBet * multiplier;
            balance += win;
            userBetPlaced = false;
            updateUI();
            
            elBtn.className = 'main-btn btn-disabled';
            elBtn.innerText = `Won ${(win).toFixed(0)}!`;
            elBtn.style.background = '#10b981'; // Green
            
            tg.HapticFeedback.notificationOccurred('success');
            
            // Send data to Bot (Optional sync)
            sendDataToBot({ change: win - currentBet });
        }

        // --- GAME LOOP ---
        
        // Start cycle automatically if idle
        setInterval(() => {
            if (gameState === 'WAITING' && !animationId) {
                startCountdown();
            }
        }, 3000); // 3 sec break between rounds

        function startCountdown() {
            gameState = 'COUNTDOWN';
            if (userBetPlaced) {
                elBtn.className = 'main-btn btn-disabled';
                elBtn.innerText = 'Wait for start...';
            } else {
                elBtn.className = 'main-btn btn-disabled';
                elBtn.innerText = 'Round starting...';
            }

            let count = 3;
            runCountAnimation(3);
            
            const timer = setInterval(() => {
                count--;
                if(count > 0) runCountAnimation(count);
                else {
                    clearInterval(timer);
                    startGame();
                }
            }, 1000);
        }

        function runCountAnimation(num) {
            const el = document.getElementById(`cnt${num}`);
            el.classList.remove('active');
            void el.offsetWidth; // trigger reflow
            el.classList.add('active');
            tg.HapticFeedback.selectionChanged();
        }

        function startGame() {
            gameState = 'FLYING';
            multiplier = 1.00;
            // Generate crash point (Simple logic)
            crashPoint = (Math.random() * 0.99) ? (1 / (1 - Math.random())) : 1.00;
            if (crashPoint > 10) crashPoint = 10; // Cap for demo
            
            elMulti.classList.add('visible');
            elMulti.classList.remove('crashed');
            
            if (userBetPlaced) {
                elBtn.className = 'main-btn btn-green';
                elBtn.innerText = 'CASH OUT';
                elBtn.style.background = ''; // Reset inline style
            } else {
                elBtn.innerText = 'Wait for next round';
            }

            animate();
        }

        function animate() {
            if (gameState !== 'FLYING') return;

            // Math logic
            multiplier += 0.005 * multiplier + 0.001;
            elMulti.innerText = multiplier.toFixed(2) + 'x';

            // Cashout button update
            if (userBetPlaced) {
                 elBtn.innerText = `Cash Out (${(currentBet * multiplier).toFixed(0)})`;
            }

            // Check Crash
            if (multiplier >= crashPoint) {
                crash();
                return;
            }

            // Draw
            drawScene(multiplier);

            animationId = requestAnimationFrame(animate);
        }

        function crash() {
            gameState = 'CRASHED';
            cancelAnimationFrame(animationId);
            
            elMulti.classList.add('crashed');
            elBtn.className = 'main-btn btn-blue';
            elBtn.innerText = 'Place bet';
            
            if (userBetPlaced) {
                // User lost
                userBetPlaced = false;
                tg.HapticFeedback.notificationOccurred('error');
            }

            addHistory(crashPoint);
            
            // Send loss data if needed
            // sendDataToBot(...)

            setTimeout(() => {
                resetGame();
            }, 2000);
        }

        function resetGame() {
            gameState = 'WAITING';
            elMulti.classList.remove('visible');
            ctx.clearRect(0, 0, W, H);
            drawStars(); // Static BG
            generateFakePlayers(); // New fake bets
        }

        // --- DRAWING ---
        let stars = Array(50).fill().map(() => ({
            x: Math.random() * 500, y: Math.random() * 300, size: Math.random() * 2, opacity: Math.random()
        }));

        function drawStars() {
            ctx.fillStyle = "#1e1e24"; // Clear
            ctx.fillRect(0,0,W,H);
            
            ctx.fillStyle = "white";
            stars.forEach(s => {
                ctx.globalAlpha = s.opacity;
                ctx.beginPath();
                ctx.arc(s.x, s.y, s.size, 0, Math.PI*2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        function drawScene(m) {
            drawStars();

            // Rocket position logic
            // Curve goes from bottom-left to mid-right
            let progress = (m - 1) / 4; 
            if (progress > 1) progress = 1;
            
            const startX = 20;
            const startY = H - 20;
            const endX = W - 50;
            const endY = 50;

            const curX = startX + (endX - startX) * progress;
            // Bezier-like curve
            const curY = startY - (startY - endY) * Math.sqrt(progress); 

            // Draw Trail
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.quadraticCurveTo(startX + 50, startY, curX, curY);
            ctx.strokeStyle = "#3b82f6";
            ctx.lineWidth = 4;
            ctx.lineCap = "round";
            ctx.stroke();

            // Draw Rocket
            ctx.save();
            ctx.translate(curX, curY);
            ctx.rotate(-Math.PI / 4); // Tilt
            ctx.font = "30px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(ROCKET_ICON, 0, 0);
            ctx.restore();
        }

        // --- FAKE PLAYERS LOGIC ---
        const fakeNames = ["Alex", "CryptoKing", "Nodirbek", "SQU1RREL", "Lynn", "GHAEM", "Fleyzix", "User99"];
        
        function generateFakePlayers() {
            const list = document.getElementById('playersList');
            list.innerHTML = ''; // Clear
            
            const count = Math.floor(Math.random() * 5) + 3; // 3-8 players
            for(let i=0; i<count; i++) {
                const name = fakeNames[Math.floor(Math.random() * fakeNames.length)];
                const bet = (Math.random() * 50 + 10).toFixed(2);
                
                const row = document.createElement('div');
                row.className = 'player-row';
                row.innerHTML = `
                    <div class="player-info">
                        <div class="avatar">${name[0]}</div>
                        <span>${name}</span>
                    </div>
                    <div class="player-bet">
                        üíé ${bet}
                    </div>
                `;
                list.appendChild(row);
            }
        }

        function addSelfToPlayersList() {
            const list = document.getElementById('playersList');
            const row = document.createElement('div');
            row.className = 'player-row';
            row.id = 'selfRow';
            row.style.background = 'rgba(59, 130, 246, 0.1)'; // Highlight self
            row.innerHTML = `
                <div class="player-info">
                    <div class="avatar" style="background:#3b82f6">YOU</div>
                    <span>You</span>
                </div>
                <div class="player-bet">
                    üíé ${currentBet}
                </div>
            `;
            list.prepend(row);
        }

        function removeSelfFromPlayers() {
            const row = document.getElementById('selfRow');
            if(row) row.remove();
        }

        function addHistory(val) {
            const div = document.createElement('div');
            // Epic Gift style colors
            let colorClass = 'badge'; 
            if(val >= 10) colorClass += ' gold';
            else if(val >= 2) colorClass += ' purple';
            else colorClass += ' blue';

            div.className = colorClass;
            div.innerText = val.toFixed(2) + 'x';
            
            elHistory.prepend(div);
            if(elHistory.children.length > 10) elHistory.lastChild.remove();
        }

        function sendDataToBot(data) {
            // Placeholder for data sync
            console.log("Send to bot:", data);
        }

    </script>
</body>
</html>
