<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Crash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; background-color: #0f1923; color: white; font-family: 'Arial', sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —Å –≥—Ä–∞—Ñ–∏–∫–æ–º */
        .game-container { position: relative; width: 100%; flex-grow: 1; overflow: hidden; background: radial-gradient(circle at bottom left, #1c252e 0%, #0f1923 70%); }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* –¶–∏—Ñ—Ä–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .multiplier-overlay {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 64px; font-weight: 900; color: white; text-shadow: 0 0 20px rgba(255,255,255,0.2);
            z-index: 10;
        }
        .crashed { color: #e74c3c !important; text-shadow: 0 0 20px rgba(231, 76, 60, 0.4); }

        /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å */
        .top-bar { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); z-index: 20; }
        .balance-box { font-size: 18px; font-weight: bold; color: #2ecc71; }
        .save-btn { background: #34495e; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–Ω–∏–∑—É */
        .controls { padding: 15px; background: #151e27; border-top: 1px solid #2c3e50; z-index: 20; }
        .input-group { display: flex; justify-content: center; margin-bottom: 10px; align-items: center; gap: 10px; }
        .bet-btn { background: #2c3e50; border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; font-weight: bold; }
        #betAmount { background: transparent; border: 2px solid #2c3e50; color: white; font-size: 20px; text-align: center; width: 100px; padding: 5px; border-radius: 10px; }
        
        /* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
        #actionBtn {
            width: 100%; padding: 18px; border: none; border-radius: 12px;
            font-size: 24px; font-weight: 900; text-transform: uppercase;
            background: #2ecc71; color: #0f1923; cursor: pointer;
            box-shadow: 0 5px 0 #27ae60; transition: all 0.1s;
        }
        #actionBtn:active { transform: translateY(4px); box-shadow: 0 0 0 #27ae60; }
        .btn-bet { background: #2ecc71; color: #0f1923; box-shadow: 0 5px 0 #27ae60; }
        .btn-cashout { background: #e67e22 !important; color: white !important; box-shadow: 0 5px 0 #d35400 !important; }
        .btn-wait { background: #7f8c8d !important; color: #bdc3c7 !important; box-shadow: none !important; pointer-events: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="balance-box" id="balanceDisplay">üí∞ 1000</div>
        <button class="save-btn" onclick="saveAndExit()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
        <div class="multiplier-overlay" id="multiplierDisplay">1.00x</div>
    </div>

    <div class="controls">
        <div class="input-group">
            <button class="bet-btn" onclick="changeBet(-100)">-</button>
            <input type="number" id="betAmount" value="100" readonly>
            <button class="bet-btn" onclick="changeBet(100)">+</button>
        </div>
        <button id="actionBtn" class="btn-bet" onclick="handleAction()">–°–¢–ê–í–ö–ê</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        // –ü–∞—Ä—Å–∏–º –±–∞–ª–∞–Ω—Å –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        let balance = parseInt(urlParams.get('balance')) || 1000;
        
        let currentBet = 100;
        let multiplier = 1.00;
        let isGameRunning = false;
        let isCrashed = false;
        let crashPoint = 0;
        let animationId;
        
        // Canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const elBalance = document.getElementById('balanceDisplay');
        const elMultiplier = document.getElementById('multiplierDisplay');
        const btn = document.getElementById('actionBtn');
        const elBet = document.getElementById('betAmount');

        function updateUI() {
            elBalance.innerText = `üí∞ ${balance}`;
            elBet.value = currentBet;
        }
        updateUI();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ Canvas
        function resize() {
            width = canvas.width = canvas.offsetWidth;
            height = canvas.height = canvas.offsetHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // === –õ–û–ì–ò–ö–ê –ò–ì–†–´ ===
        function changeBet(val) {
            if (isGameRunning) return;
            let newBet = currentBet + val;
            if (newBet >= 100 && newBet <= balance) {
                currentBet = newBet;
                updateUI();
            }
        }

        function handleAction() {
            if (!isGameRunning) {
                // –°—Ç–∞—Ä—Ç –∏–≥—Ä—ã
                if (balance < currentBet) {
                    tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
                    return;
                }
                startGame();
            } else {
                // –ö—ç—à–∞—É—Ç (–ó–∞–±—Ä–∞—Ç—å –¥–µ–Ω—å–≥–∏)
                cashOut();
            }
        }

        function startGame() {
            isGameRunning = true;
            isCrashed = false;
            multiplier = 1.00;
            
            // –°–ø–∏—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫—É
            balance -= currentBet;
            updateUI();

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ—á–∫—É –∫—Ä–∞—à–∞ (—á–µ—Å—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞)
            // –í —Å—Ä–µ–¥–Ω–µ–º –∫—Ä–∞—à–∏—Ç—Å—è –Ω–∞ 2.0, –Ω–æ –º–æ–∂–µ—Ç –∏ –Ω–∞ 1.0
            crashPoint = generateCrashPoint();
            console.log("Crash at:", crashPoint); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

            // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É
            btn.className = 'btn-cashout';
            btn.innerText = '–ó–ê–ë–†–ê–¢–¨';
            elMultiplier.classList.remove('crashed');

            animate();
        }

        function generateCrashPoint() {
            // –§–æ—Ä–º—É–ª–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–∞–∑–∏–Ω–æ)
            // e = 2^32
            const e = 2 ** 32;
            const h = crypto.getRandomValues(new Uint32Array(1))[0];
            if (h % 33 === 0) return 1.00; // 3% —à–∞–Ω—Å –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –∫—Ä–∞—à–∞
            return Math.floor((100 * e - h) / (e - h)) / 100;
        }

        function cashOut() {
            if (!isGameRunning || isCrashed) return;
            
            isGameRunning = false;
            const win = Math.floor(currentBet * multiplier);
            balance += win;
            updateUI();

            btn.className = 'btn-bet';
            btn.innerText = '–°–¢–ê–í–ö–ê';
            
            tg.HapticFeedback.notificationOccurred('success');
            elMultiplier.style.color = '#2ecc71';
            elMultiplier.innerText = `+${win}`;
            
            cancelAnimationFrame(animationId);
            // –ñ–¥–µ–º —á—É—Ç—å-—á—É—Ç—å –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
            setTimeout(() => { resetGameView() }, 2000);
        }

        function crash() {
            isGameRunning = false;
            isCrashed = true;
            
            tg.HapticFeedback.notificationOccurred('error');
            
            btn.className = 'btn-wait';
            btn.innerText = '–ö–†–ê–®!';
            
            elMultiplier.classList.add('crashed');
            elMultiplier.innerText = `CRASH @ ${multiplier.toFixed(2)}x`;
            
            cancelAnimationFrame(animationId);
            setTimeout(() => { 
                resetGameView();
                btn.className = 'btn-bet';
                btn.innerText = '–°–¢–ê–í–ö–ê';
            }, 2000);
        }

        function resetGameView() {
            multiplier = 1.00;
            elMultiplier.innerText = "1.00x";
            elMultiplier.style.color = "white";
            elMultiplier.classList.remove('crashed');
            ctx.clearRect(0, 0, width, height);
        }

        // === –ì–†–ê–§–ò–ö–ê –ò –ê–ù–ò–ú–ê–¶–ò–Ø ===
        function animate() {
            if (!isGameRunning) return;

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å (—ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç)
            multiplier += 0.005 * multiplier; 
            
            elMultiplier.innerText = multiplier.toFixed(2) + 'x';
            btn.innerText = `–ó–ê–ë–†–ê–¢–¨ ${(currentBet * multiplier).toFixed(0)}`;

            if (multiplier >= crashPoint) {
                crash();
                return;
            }

            // –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
            drawGraph(multiplier);
            animationId = requestAnimationFrame(animate);
        }

        function drawGraph(currentM) {
            ctx.clearRect(0, 0, width, height);
            
            // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            // –ß–µ–º –±–æ–ª—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å, —Ç–µ–º –≤—ã—à–µ —Ç–æ—á–∫–∞, –Ω–æ –æ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —É–ª–µ—Ç–∞—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω
            // –ú—ã "–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º" –≥—Ä–∞—Ñ–∏–∫, —á—Ç–æ–±—ã —Ä–∞–∫–µ—Ç–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –≤ –≤–∏–¥–∏–º–æ–π –∑–æ–Ω–µ
            
            ctx.beginPath();
            ctx.strokeStyle = '#e67e22';
            ctx.lineWidth = 5;
            
            // –†–∏—Å—É–µ–º –∫—Ä–∏–≤—É—é –ë–µ–∑—å–µ
            ctx.moveTo(0, height);
            
            // –ü—Ä–æ—Å—Ç–∞—è –∫—Ä–∏–≤–∞—è –≤–≤–µ—Ä—Ö
            let x = width * 0.8; // –†–∞–∫–µ—Ç–∞ –≤—Å–µ–≥–¥–∞ –Ω–∞ 80% —à–∏—Ä–∏–Ω—ã
            let progress = (currentM - 1) / 2; // –ú–∞—Å—à—Ç–∞–± –≤—ã—Å–æ—Ç—ã
            if (progress > 0.8) progress = 0.8; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
            
            let y = height - (height * progress);
            
            ctx.quadraticCurveTo(width * 0.4, height, x, y);
            ctx.stroke();

            // –†–∏—Å—É–µ–º –†–∞–∫–µ—Ç—É üöÄ –Ω–∞ –∫–æ–Ω—Ü–µ –ª–∏–Ω–∏–∏
            ctx.font = "40px Arial";
            ctx.fillText("üöÄ", x - 20, y);
            
            // –†–∏—Å—É–µ–º –∑–æ–Ω—É –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º
            ctx.lineTo(x, height);
            ctx.lineTo(0, height);
            ctx.fillStyle = "rgba(230, 126, 34, 0.2)";
            ctx.fill();
        }

        // === –°–û–•–†–ê–ù–ï–ù–ò–ï ===
        function saveAndExit() {
            tg.sendData(JSON.stringify({ balance: balance }));
            tg.close();
        }
    </script>
</body>
</html>
