<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypto Crash Live</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { margin: 0; background: #0f1923; color: white; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* Game Area */
        .game-wrapper {
            position: relative;
            flex-grow: 1;
            background: radial-gradient(circle at bottom, #1c252e 0%, #000000 100%);
            border-bottom: 2px solid #333;
        }
        canvas { display: block; width: 100%; height: 100%; }

        .center-info {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none;
        }
        .multiplier { font-size: 60px; font-weight: 900; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .crashed { color: #ff4757; text-shadow: 0 0 20px rgba(255, 71, 87, 0.5); }
        .status { font-size: 20px; color: #aaa; margin-top: 10px; }

        /* Controls */
        .controls { padding: 15px; background: #151e27; z-index: 10; }
        
        .history { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; height: 30px; }
        .badge { padding: 5px 10px; border-radius: 5px; background: #333; font-size: 12px; font-weight: bold; flex-shrink: 0; }
        .badge.green { color: #2ecc71; background: rgba(46, 204, 113, 0.2); }
        .badge.red { color: #ff4757; background: rgba(255, 71, 87, 0.2); }

        .bet-panel { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-box { flex: 1; background: #0f1923; border: 1px solid #333; border-radius: 10px; color: white; padding: 10px; text-align: center; font-size: 18px; }
        
        .btn { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 20px; font-weight: bold; cursor: pointer; color: white; transition: 0.1s; }
        .btn-bet { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-bet:active { transform: translateY(2px); box-shadow: none; }
        .btn-cashout { background: #f39c12; box-shadow: 0 4px 0 #d35400; }
        .btn-wait { background: #34495e; color: #7f8c8d; pointer-events: none; }

        .balance { font-size: 14px; color: #2ecc71; margin-bottom: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="game-wrapper">
        <canvas id="canvas"></canvas>
        <div class="center-info">
            <div id="mDisplay" class="multiplier">1.00x</div>
            <div id="statusDisplay" class="status">Connecting...</div>
        </div>
    </div>

    <div class="controls">
        <div class="balance">
            <span>BALANCE: <b id="balDisplay">0</b></span>
            <span id="connStatus">ðŸ”´ Offline</span>
        </div>
        
        <div class="history" id="historyRow"></div>

        <div class="bet-panel">
            <button onclick="adjBet(-50)" style="background:#333; border:none; color:white; border-radius:5px; width:40px;">-</button>
            <input type="number" id="betInput" class="input-box" value="100" readonly>
            <button onclick="adjBet(50)" style="background:#333; border:none; color:white; border-radius:5px; width:40px;">+</button>
        </div>

        <button id="mainBtn" class="btn btn-wait" onclick="action()">LOADING...</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // ==========================================================
        // ðŸ”´ Ð’Ð¡Ð¢ÐÐ’Ð¬ Ð¡Ð®Ð”Ð Ð¡Ð’ÐžÐ™ Ð”ÐžÐœÐ•Ð Ð¡ BOTHOST (Ñ https://)
        // ÐŸÑ€Ð¸Ð¼ÐµÑ€: const SERVER_URL = "https://bot-12345.bothost.ru";
        const SERVER_URL = "https://Ð’ÐÐ¨_Ð”ÐžÐœÐ•Ð_Ð¡_BOTHOST.ru"; 
        // ==========================================================

        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');

        let socket;
        let gameState = "WAITING";
        let myBet = 0;
        let isBetting = false;
        let currentMultiplier = 1.00;
        let canvas, ctx, W, H;

        // Init
        initGame();

        function initGame() {
            if (SERVER_URL.includes("Ð’ÐÐ¨_Ð”ÐžÐœÐ•Ð")) {
                alert("ÐžÑˆÐ¸Ð±ÐºÐ°! Ð’ÑÑ‚Ð°Ð²ÑŒ Ð´Ð¾Ð¼ÐµÐ½ Bothost Ð² index.html");
                return;
            }

            socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });

            socket.on('connect', () => {
                document.getElementById('connStatus').innerText = "ðŸŸ¢ Online";
                // ÐÐ²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ñ
                if(userId) socket.emit('auth', { user_id: userId });
            });

            socket.on('balance_update', (bal) => {
                document.getElementById('balDisplay').innerText = bal;
                tg.HapticFeedback.selectionChanged();
            });

            socket.on('game_update', (data) => {
                gameState = data.status;
                updateHistory(data.history);
                updateUI();
            });

            socket.on('tick', (m) => {
                currentMultiplier = m;
                gameState = "FLYING";
                drawRocket(m);
                document.getElementById('mDisplay').innerText = m.toFixed(2) + "x";
                
                if (isBetting) {
                    const win = Math.floor(myBet * m);
                    document.getElementById('mainBtn').innerText = `CASHOUT (${win})`;
                    document.getElementById('mainBtn').className = "btn btn-cashout";
                }
            });

            socket.on('crash', (data) => {
                gameState = "CRASHED";
                currentMultiplier = data.multiplier;
                document.getElementById('mDisplay').innerText = "CRASH " + data.multiplier.toFixed(2) + "x";
                document.getElementById('mDisplay').classList.add('crashed');
                isBetting = false; // Ð¡Ñ‚Ð°Ð²ÐºÐ° ÑÐ³Ð¾Ñ€ÐµÐ»Ð°
                tg.HapticFeedback.notificationOccurred('error');
                updateUI();
            });

            socket.on('bet_confirmed', (amount) => {
                isBetting = true;
                myBet = amount;
                updateUI();
            });

            socket.on('win_notification', (amount) => {
                isBetting = false;
                tg.HapticFeedback.notificationOccurred('success');
                alert(`YOU WON ${amount}!`);
                updateUI();
            });
            
            initCanvas();
        }

        function action() {
            if (gameState === "WAITING" && !isBetting) {
                const amount = parseInt(document.getElementById('betInput').value);
                socket.emit('place_bet', amount);
            } else if (gameState === "FLYING" && isBetting) {
                socket.emit('cash_out');
            }
        }

        function updateUI() {
            const btn = document.getElementById('mainBtn');
            const status = document.getElementById('statusDisplay');
            const mDisp = document.getElementById('mDisplay');

            if (gameState === "WAITING") {
                mDisp.classList.remove('crashed');
                mDisp.innerText = "1.00x";
                status.innerText = "Place your bets...";
                drawRocket(1.0); // Reset canvas
                
                if (isBetting) {
                    btn.className = "btn btn-wait";
                    btn.innerText = "BET PLACED...";
                } else {
                    btn.className = "btn btn-bet";
                    btn.innerText = "PLACE BET";
                }
            } else if (gameState === "CRASHED") {
                btn.className = "btn btn-wait";
                btn.innerText = "WAITING NEXT ROUND";
                status.innerText = "Crashed!";
            }
        }

        function updateHistory(hist) {
            const div = document.getElementById('historyRow');
            div.innerHTML = "";
            hist.forEach(h => {
                const badge = document.createElement('div');
                badge.className = h >= 2.0 ? "badge green" : "badge red";
                badge.innerText = h.toFixed(2) + "x";
                div.appendChild(badge);
            });
        }

        function adjBet(val) {
            let el = document.getElementById('betInput');
            let v = parseInt(el.value) + val;
            if(v >= 50) el.value = v;
        }

        // --- GRAPHICS ---
        function initCanvas() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            resize();
            window.addEventListener('resize', resize);
        }
        function resize() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            W = canvas.width; H = canvas.height;
        }
        function drawRocket(m) {
            ctx.clearRect(0, 0, W, H);
            
            // Grid
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            ctx.beginPath();
            for(let i=0; i<W; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,H); }
            ctx.stroke();

            // Rocket Path
            let progress = (m - 1) / 4; 
            if(progress > 0.9) progress = 0.9;
            
            let x = 50 + (W - 100) * progress;
            let y = (H - 50) - (H - 100) * progress;

            ctx.beginPath();
            ctx.strokeStyle = "#2ecc71";
            ctx.lineWidth = 4;
            ctx.moveTo(50, H-50);
            ctx.quadraticCurveTo(x, H-50, x, y);
            ctx.stroke();

            // Rocket Icon
            ctx.save();
            ctx.translate(x, y);
            ctx.font = "30px Arial";
            ctx.fillText("ðŸš€", -15, 10);
            
            // Particle Trail (Simple)
            ctx.fillStyle = "orange";
            ctx.beginPath();
            ctx.arc(-20, 15, 5 + Math.random()*5, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
        }
    </script>
</body>
</html>
