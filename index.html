<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Crash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --neon-green: #00ff88;
            --neon-blue: #00d2ff;
            --crash-red: #ff4757;
            --bg-dark: #0a0e17;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            background: radial-gradient(circle at center, #1a1f2e 0%, #0a0e17 100%);
            color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- UI ELEMENTS --- */
        .top-bar {
            padding: 15px;
            background: rgba(10, 14, 23, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .balance-container {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .history-panel {
            position: absolute;
            right: 15px;
            top: 70px;
            width: 80px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        .history-pill {
            background: var(--glass);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            border: 1px solid var(--border);
        }
        .win { color: var(--neon-green); border-color: rgba(0,255,136,0.3); }
        .lose { color: var(--crash-red); border-color: rgba(255,71,87,0.3); }

        /* --- GAME AREA --- */
        .game-area {
            position: relative;
            flex-grow: 1;
            width: 100%;
        }

        canvas { display: block; width: 100%; height: 100%; }

        .multiplier-display {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 64px;
            font-weight: 900;
            color: white;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.2);
            pointer-events: none;
            transition: color 0.2s;
        }
        
        .pulse-anim { animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { text-shadow: 0 0 20px var(--neon-green); } to { text-shadow: 0 0 50px var(--neon-green); } }

        /* --- CONTROLS --- */
        .controls {
            padding: 20px;
            background: rgba(20, 25, 35, 0.9);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .bet-input-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: var(--glass);
            border: 1px solid var(--border);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            font-size: 20px;
            cursor: pointer;
        }

        #betInput {
            background: transparent;
            border: 1px solid var(--border);
            color: white;
            font-size: 24px;
            text-align: center;
            width: 120px;
            padding: 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        #actionBtn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 22px;
            font-weight: 800;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn-play {
            background: linear-gradient(135deg, var(--neon-green), #00b894);
            color: #0a0e17;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        .btn-cashout {
            background: linear-gradient(135deg, #ffa502, #ff6b35);
            color: white;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.5);
            animation: glow 1s infinite alternate;
        }
        
        .btn-disabled { background: #333; color: #777; pointer-events: none; }

        @keyframes glow { from { box-shadow: 0 0 20px #ff6b35; } to { box-shadow: 0 0 40px #ff6b35; } }

    </style>
</head>
<body>

    <div class="top-bar">
        <div class="balance-container" id="balanceDisplay">loading...</div>
        <div style="font-size: 12px; color: #888;">AUTO-SAVE ON</div>
    </div>

    <div class="game-area">
        <canvas id="gameCanvas"></canvas>
        <div class="multiplier-display" id="mainDisplay">1.00x</div>
        <div class="history-panel" id="historyPanel"></div>
    </div>

    <div class="controls">
        <div class="bet-input-row">
            <button class="control-btn" onclick="adjustBet(-50)">‚àí</button>
            <input type="number" id="betInput" value="100" readonly>
            <button class="control-btn" onclick="adjustBet(50)">+</button>
        </div>
        <button id="actionBtn" class="btn-play" onclick="handleAction()">–°–¢–ê–í–ö–ê</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation(); // –°–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º

        // --- CORE VARIABLES ---
        const urlParams = new URLSearchParams(window.location.search);
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–ª–∞–Ω—Å. –ï—Å–ª–∏ –Ω–µ—Ç –≤ URL, —Å—Ç–∞–≤–∏–º 0 (–∑–∞—â–∏—Ç–∞ –æ—Ç —Ö–∞–ª—è–≤—ã, —Ä–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ –±—ç–∫–µ)
        let balance = parseInt(urlParams.get('start_balance')) || 0;
        let currentBet = 100;
        
        let state = 'IDLE'; // IDLE, FLYING, CRASHED
        let multiplier = 1.00;
        let crashPoint = 0;
        let gameLoopId;
        let particles = [];
        
        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let W, H;

        // UI Elements
        const elBalance = document.getElementById('balanceDisplay');
        const elDisplay = document.getElementById('mainDisplay');
        const elBtn = document.getElementById('actionBtn');
        const elHistory = document.getElementById('historyPanel');

        // Init
        resize();
        window.addEventListener('resize', resize);
        updateUI();

        function resize() {
            W = canvas.width = canvas.offsetWidth;
            H = canvas.height = canvas.offsetHeight;
        }

        function updateUI() {
            elBalance.innerText = `üí∞ ${balance.toLocaleString()}`;
        }

        function adjustBet(amount) {
            if (state !== 'IDLE') return;
            let newBet = currentBet + amount;
            if (newBet >= 50 && newBet <= balance) {
                currentBet = newBet;
                document.getElementById('betInput').value = currentBet;
                tg.HapticFeedback.selectionChanged();
            }
        }

        // --- GAME LOGIC ---

        function generateCrashPoint() {
            // PROVABLY FAIR LOGIC
            // –ï—Å–ª–∏ crypto –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º Math.random (Fallback)
            try {
                const array = new Uint32Array(1);
                window.crypto.getRandomValues(array);
                const h = array[0];
                const e = 2 ** 32;
                if (h % 33 === 0) return 1.00; // House Edge 3%
                return Math.floor((100 * e - h) / (e - h)) / 100;
            } catch (err) {
                console.warn("Crypto API not supported, using Math fallback");
                return (Math.random() * 0.99) ? (1 / (1 - Math.random())) : 1.00; 
            }
        }

        function handleAction() {
            if (state === 'IDLE') {
                startGame();
            } else if (state === 'FLYING') {
                cashOut();
            }
        }

        function startGame() {
            if (balance < currentBet) {
                tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!");
                return;
            }

            // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ
            balance -= currentBet;
            updateUI();
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –±–æ—Ç—É (Delta update)
            sendDataToBot({ change: -currentBet });

            state = 'FLYING';
            multiplier = 1.00;
            crashPoint = generateCrashPoint();
            particles = []; // –û—á–∏—Å—Ç–∫–∞ —á–∞—Å—Ç–∏—Ü
            
            // UI Updates
            elBtn.className = 'btn-cashout';
            elBtn.innerText = '–ó–ê–ë–†–ê–¢–¨';
            elDisplay.classList.add('pulse-anim');
            elDisplay.style.color = "white";
            
            tg.HapticFeedback.impactOccurred('light');
            animate();
        }

        function cashOut() {
            if (state !== 'FLYING') return;
            state = 'IDLE'; // –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ (–ø–æ–±–µ–¥–∞)
            
            const winAmount = Math.floor(currentBet * multiplier);
            balance += winAmount;
            updateUI();

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–∏–≥—Ä—ã—à–∞ –±–æ—Ç—É
            sendDataToBot({ change: winAmount });

            elBtn.className = 'btn-play';
            elBtn.innerText = '–°–¢–ê–í–ö–ê';
            elDisplay.classList.remove('pulse-anim');
            elDisplay.style.color = '#00ff88';
            elDisplay.innerText = `+${winAmount}`;
            
            addHistory(multiplier, true);
            tg.HapticFeedback.notificationOccurred('success');
            
            // –°—Ç–æ–ø –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 1 —Å–µ–∫
            setTimeout(() => { cancelAnimationFrame(gameLoopId); clearCanvas(); elDisplay.innerText = "1.00x"; elDisplay.style.color = "white"; }, 2000);
        }

        function crash() {
            state = 'CRASHED';
            createParticles(W * 0.8, calculateRocketY(multiplier)); // –í–∑—Ä—ã–≤ –≤ –º–µ—Å—Ç–µ —Ä–∞–∫–µ—Ç—ã
            
            elBtn.className = 'btn-disabled';
            elBtn.innerText = 'CRASHED';
            elDisplay.classList.remove('pulse-anim');
            elDisplay.style.color = '#ff4757';
            
            tg.HapticFeedback.notificationOccurred('error');
            addHistory(multiplier, false);

            setTimeout(() => {
                state = 'IDLE';
                elBtn.className = 'btn-play';
                elBtn.innerText = '–°–¢–ê–í–ö–ê';
                clearCanvas();
                elDisplay.innerText = "1.00x";
                elDisplay.style.color = "white";
            }, 2000);
        }

        // --- DATA SYNC ---
        function sendDataToBot(data) {
            // –ú—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É, –Ω–æ –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            // –í–Ω–∏–º–∞–Ω–∏–µ: tg.sendData –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ. –î–ª—è realtime –æ–±—â–µ–Ω–∏—è –Ω—É–∂–µ–Ω WebSocket.
            // –¢.–∫. —É –Ω–∞—Å Mini App, –º—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º –∏—Ç–æ–≥ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º sendData –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.
            // –•–ê–ö: –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–æ, –º—ã –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ.
            // –†–µ–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–í –º–µ–Ω—é" –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ API –∑–∞–ø—Ä–æ—Å—ã (–µ—Å–ª–∏ –±—ã –±—ã–ª —Å–µ—Ä–≤–µ—Ä).
            // –í —Ä–∞–º–∫–∞—Ö –∑–∞–¥–∞—á–∏ "Telegram Bot API" -> –º—ã –æ—Ç–ø—Ä–∞–≤–∏–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —é–∑–µ—Ä —Ä–µ—à–∏—Ç –≤—ã–π—Ç–∏ –∏–ª–∏ –º—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä–æ–µ–º —Å–µ—Å—Å–∏—é.
            
            // –ù–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏–ª "–ö—Ä—É—Ç–æ". –°–¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –Ω–µ—Ç, –∑–Ω–∞—á–∏—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ CashOut? 
            // –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, sendData –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç WebApp.
            // –ü–æ—ç—Ç–æ–º—É, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å –¥–æ–ª–≥–æ, –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ Bot API. 
            // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –±–µ–∑ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ - CloudStorage (tg.CloudStorage).
            // –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥:
            console.log("Syncing balance:", data);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–í–´–ô–¢–ò –ò –°–û–•–†–ê–ù–ò–¢–¨" –≤ UI (–º–æ–∂–Ω–æ –≤ Top Bar)
        const saveBtn = document.createElement('button');
        saveBtn.innerText = "üíæ";
        saveBtn.style = "background:none; border:none; font-size:20px; cursor:pointer;";
        saveBtn.onclick = () => {
            // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É —Å –Ω–∞—á–∞–ª—å–Ω—ã–º –±–∞–ª–∞–Ω—Å–æ–º
            let startBal = parseInt(urlParams.get('start_balance')) || 0;
            let diff = balance - startBal;
            tg.sendData(JSON.stringify({ change: diff }));
        };
        document.querySelector('.top-bar').appendChild(saveBtn);


        // --- RENDERING & PHYSICS ---

        function calculateRocketY(m) {
            // –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è —à–∫–∞–ª–∞ –≤—ã—Å–æ—Ç—ã
            let progress = (m - 1) / 2; 
            if (progress > 0.8) progress = 0.8;
            return H - (H * 0.2) - (H * 0.6 * progress);
        }

        function animate() {
            if (state === 'IDLE') return;

            ctx.clearRect(0, 0, W, H);
            
            if (state === 'FLYING') {
                multiplier += 0.005 * multiplier + 0.001; // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç
                elDisplay.innerText = multiplier.toFixed(2) + 'x';
                elBtn.innerText = `–ó–ê–ë–†–ê–¢–¨ ${(currentBet * multiplier).toFixed(0)}`;

                if (multiplier >= crashPoint) {
                    crash();
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, —á—Ç–æ–±—ã –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–∏–∫–ª—ã
                }
            }

            // Draw Graph Line
            ctx.beginPath();
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 4;
            ctx.lineCap = 'round';
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#00ff88';
            
            let startX = 0;
            let startY = H;
            let endX = W * 0.8;
            let endY = calculateRocketY(multiplier);
            
            // –ö—Ä–∏–≤–∞—è –ë–µ–∑—å–µ
            ctx.moveTo(startX, startY);
            ctx.quadraticCurveTo(W * 0.3, H, endX, endY);
            ctx.stroke();
            ctx.shadowBlur = 0;

            // Draw Rocket
            if (state === 'FLYING') {
                drawRocket(endX, endY);
            }

            // Draw Particles
            updateParticles();

            gameLoopId = requestAnimationFrame(animate);
        }

        function drawRocket(x, y) {
            ctx.save();
            ctx.translate(x, y);
            // Rocket Emoji or Shape
            ctx.font = "40px Arial";
            ctx.shadowColor = "#00d2ff";
            ctx.shadowBlur = 30;
            ctx.fillStyle = "#fff";
            ctx.fillText("üöÄ", -20, 10);
            
            // Engine Flame
            ctx.beginPath();
            ctx.fillStyle = `rgba(255, 100, 0, ${Math.random()})`;
            ctx.arc(-25, 5, 10 + Math.random()*5, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();
        }

        function createParticles(x, y) {
            for(let i=0; i<30; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    alpha: 1,
                    color: Math.random() > 0.5 ? '#ff4757' : '#ffa502'
                });
            }
        }

        function updateParticles() {
            for(let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.5; // Gravity
                p.alpha -= 0.02;
                
                ctx.globalAlpha = p.alpha;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;

                if(p.alpha <= 0) particles.splice(i, 1);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, W, H);
        }

        function addHistory(val, win) {
            const div = document.createElement('div');
            div.className = `history-pill ${win ? 'win' : 'lose'}`;
            div.innerText = val.toFixed(2) + 'x';
            elHistory.prepend(div);
            if (elHistory.children.length > 6) elHistory.lastChild.remove();
        }

    </script>
</body>
</html>
