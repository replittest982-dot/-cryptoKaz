<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Epic Crash Live</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121214; --card-bg: #1d1d1f;
            --accent-blue: #3b82f6; --accent-green: #10b981;
            --text-color: #ffffff; --text-secondary: #9ca3af;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* HEADER */
        .header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .status-badge { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 12px; font-size: 12px; color: #4ade80; }
        .dot { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 5px #4ade80; }
        .balance-pill { background: #252528; padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1); }
        .diamond-icon { color: #3b82f6; font-size: 14px; }

        /* GAME AREA */
        .game-wrapper { position: relative; width: 100%; height: 280px; background: radial-gradient(circle at bottom, #1e1e24 0%, #121214 70%); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        
        .center-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
        .countdown { font-size: 80px; font-weight: 900; color: white; text-shadow: 0 0 30px rgba(255,255,255,0.2); opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        .countdown.active { animation: popIn 0.8s forwards; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0; transform: scale(1.5); } }

        .multiplier-text { font-size: 56px; font-weight: 800; color: white; opacity: 0; transition: color 0.2s; }
        .multiplier-text.visible { opacity: 1; }
        .multiplier-text.crashed { color: #ef4444; text-shadow: 0 0 30px rgba(239, 68, 68, 0.4); }

        /* CONTROLS */
        .controls-container { background: var(--bg-color); padding: 10px 16px; border-top-left-radius: 20px; border-top-right-radius: 20px; margin-top: -20px; z-index: 20; position: relative; }
        .history-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 5px; height: 35px; }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; flex-shrink: 0; background: #2a2a2c; color: #9ca3af; display: flex; align-items: center; }
        .badge.purple { color: #c084fc; background: rgba(192, 132, 252, 0.15); }
        .badge.gold { color: #fbbf24; background: rgba(251, 191, 36, 0.15); }
        .badge.blue { color: #60a5fa; background: rgba(96, 165, 250, 0.15); }
        
        .main-btn { width: 100%; height: 56px; border-radius: 16px; border: none; font-size: 18px; font-weight: 700; color: white; cursor: pointer; transition: transform 0.1s; margin-bottom: 15px; }
        .main-btn:active { transform: scale(0.98); }
        .btn-blue { background: #3b82f6; box-shadow: 0 4px 0 #2563eb; }
        .btn-red { background: #ef4444; box-shadow: 0 4px 0 #dc2626; }
        .btn-green { background: #10b981; box-shadow: 0 4px 0 #059669; }
        .btn-disabled { background: #374151; color: #9ca3af; box-shadow: none; pointer-events: none; }

        .bet-inputs { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-box { background: #1d1d1f; border: 1px solid #333; border-radius: 12px; padding: 8px; flex: 1; display: flex; justify-content: space-between; align-items: center; }
        .input-val { font-weight: bold; }

        /* LIST & NAV */
        .players-list { flex: 1; overflow-y: auto; padding: 0 16px; background: var(--bg-color); }
        .player-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .avatar { width: 24px; height: 24px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 10px; margin-right: 8px; }
        .bottom-nav { display: flex; justify-content: space-around; padding: 10px 0; background: #18181b; border-top: 1px solid rgba(255,255,255,0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 10px; color: #6b7280; }
        .nav-item.active { color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="status-badge" id="connStatus"><div class="dot"></div> Connecting...</div>
        <div class="balance-pill"><span class="diamond-icon">üíé</span><span id="balanceDisplay">0</span></div>
    </div>

    <div class="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        <div class="center-overlay countdown" id="cnt3">3</div>
        <div class="center-overlay countdown" id="cnt2">2</div>
        <div class="center-overlay countdown" id="cnt1">1</div>
        <div class="center-overlay multiplier-text" id="multiDisplay">1.00x</div>
    </div>

    <div class="controls-container">
        <div class="history-row" id="historyRow"></div>
        <div class="bet-inputs">
            <div class="input-box" onclick="adjBet(-50)"><span>Bet</span><span class="input-val" id="betVal">100</span></div>
            <div class="input-box" onclick="adjBet(50)"><span>+50</span></div>
        </div>
        <button class="main-btn btn-disabled" id="actionBtn" onclick="handleAction()">Loading...</button>
    </div>

    <div class="players-list" id="playersList"></div> <div class="bottom-nav">
        <div class="nav-item"><span style="font-size:20px">üéí</span>Backpack</div>
        <div class="nav-item active"><span style="font-size:20px">üè†</span>Home</div>
        <div class="nav-item"><span style="font-size:20px">üí∞</span>Earn</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // üî• –í–ê–ñ–ù–û: –¢–≤–æ–π –¥–æ–º–µ–Ω Bothost
        const SERVER_URL = "https://bot_1766306473_1270_metropabg189-gmail-c.bothost.ru";
        
        const socket = io(SERVER_URL, { transports: ['websocket', 'polling'] });
        
        // Data
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');
        let currentBet = 100;
        let isBetting = false;
        let gameState = "WAITING";
        
        // UI
        const elBal = document.getElementById('balanceDisplay');
        const elBtn = document.getElementById('actionBtn');
        const elMulti = document.getElementById('multiDisplay');
        const elConn = document.getElementById('connStatus');
        
        // --- SOCKET LOGIC ---
        socket.on('connect', () => {
            elConn.innerHTML = '<div class="dot"></div> Live';
            if(userId) socket.emit('auth', { user_id: userId });
        });

        socket.on('balance', (bal) => {
            elBal.innerText = bal;
            tg.HapticFeedback.selectionChanged();
        });

        socket.on('game_update', (data) => {
            gameState = data.status;
            renderHistory(data.history);
            if(gameState === "WAITING") startCountdownUI();
        });

        socket.on('tick', (m) => {
            gameState = "FLYING";
            elMulti.innerText = m.toFixed(2) + "x";
            elMulti.classList.add('visible');
            elMulti.classList.remove('crashed');
            drawScene(m);
            
            if(isBetting) {
                elBtn.className = "main-btn btn-green";
                elBtn.innerText = `CASH OUT (${(currentBet * m).toFixed(0)})`;
            } else {
                elBtn.className = "main-btn btn-disabled";
                elBtn.innerText = "Round in progress...";
            }
        });

        socket.on('crash', (data) => {
            gameState = "CRASHED";
            elMulti.innerText = "CRASH " + data.m.toFixed(2) + "x";
            elMulti.classList.add('crashed');
            
            elBtn.className = "main-btn btn-disabled";
            elBtn.innerText = "Wait for next round";
            
            if(isBetting) {
                isBetting = false;
                tg.HapticFeedback.notificationOccurred('error');
            }
        });

        socket.on('bet_confirmed', () => {
            isBetting = true;
            elBtn.className = "main-btn btn-red";
            elBtn.innerText = "BET PLACED";
            addSelfToPlayers();
        });

        socket.on('win', (amount) => {
            isBetting = false;
            tg.HapticFeedback.notificationOccurred('success');
            elBtn.className = "main-btn btn-green";
            elBtn.innerText = `WON ${amount}`;
            setTimeout(() => { resetBtn() }, 2000);
        });

        // --- UI LOGIC ---
        function handleAction() {
            if(gameState === "WAITING" && !isBetting) {
                socket.emit('place_bet', currentBet);
            } else if (gameState === "FLYING" && isBetting) {
                socket.emit('cash_out');
            }
        }

        function adjBet(val) {
            let v = currentBet + val;
            if (v >= 50) {
                currentBet = v;
                document.getElementById('betVal').innerText = currentBet;
            }
        }

        function resetBtn() {
            if(gameState === "WAITING" && !isBetting) {
                elBtn.className = "main-btn btn-blue";
                elBtn.innerText = "Place Bet";
            }
        }

        function startCountdownUI() {
            resetBtn();
            ctx.clearRect(0,0,W,H);
            drawStars();
            elMulti.classList.remove('visible');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è 3-2-1 (–ª–æ–∫–∞–ª—å–Ω–∞—è, –Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –æ–∂–∏–¥–∞–Ω–∏–µ–º —Å–µ—Ä–≤–µ—Ä–∞)
            setTimeout(() => runAnim(3), 1000);
            setTimeout(() => runAnim(2), 2000);
            setTimeout(() => runAnim(1), 3000);
            generateFakePlayers(); // Refresh list
        }

        function runAnim(n) {
            const el = document.getElementById(`cnt${n}`);
            el.classList.remove('active');
            void el.offsetWidth;
            el.classList.add('active');
            tg.HapticFeedback.impactOccurred('light');
        }

        function renderHistory(hist) {
            const div = document.getElementById('historyRow');
            div.innerHTML = "";
            hist.forEach(val => {
                const b = document.createElement('div');
                let cls = 'badge blue';
                if(val >= 10) cls = 'badge gold';
                else if(val >= 2) cls = 'badge purple';
                b.className = cls;
                b.innerText = val.toFixed(2) + "x";
                div.appendChild(b);
            });
        }

        // --- GRAPHICS & FAKE PLAYERS ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let W, H;
        
        function resize() { W = canvas.width = canvas.offsetWidth; H = canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resize); resize();

        let stars = Array(40).fill().map(() => ({x:Math.random()*500, y:Math.random()*300, s:Math.random()*2}));
        function drawStars() {
            ctx.fillStyle = "#1e1e24"; ctx.fillRect(0,0,W,H);
            ctx.fillStyle = "white";
            stars.forEach(s => { ctx.globalAlpha=0.5; ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, 6.28); ctx.fill(); });
            ctx.globalAlpha = 1;
        }

        function drawScene(m) {
            drawStars();
            let p = (m-1)/4; if(p>1) p=1;
            let x = 30 + (W-60)*p;
            let y = (H-30) - (H-60)*Math.sqrt(p); // –ö—Ä–∏–≤–∞—è

            ctx.beginPath(); ctx.moveTo(30, H-30); ctx.quadraticCurveTo(30 + (W-60)*0.5, H-30, x, y);
            ctx.strokeStyle = "#3b82f6"; ctx.lineWidth = 4; ctx.stroke();

            ctx.save(); ctx.translate(x, y); ctx.font="30px Arial"; ctx.fillText("üöÄ", -15, 10); ctx.restore();
        }

        // Fake Players for ambience
        const names = ["Alex", "User1", "Winner", "Crypto", "Lynn"];
        function generateFakePlayers() {
            const l = document.getElementById('playersList'); l.innerHTML = "";
            for(let i=0; i<5; i++) {
                let n = names[Math.floor(Math.random()*names.length)];
                l.innerHTML += `<div class="player-row"><div style="display:flex;align-items:center"><div class="avatar">${n[0]}</div>${n}</div><div style="color:#9ca3af">üíé ${(Math.random()*50+10).toFixed(0)}</div></div>`;
            }
        }
        function addSelfToPlayers() {
            const l = document.getElementById('playersList');
            l.innerHTML = `<div class="player-row" style="background:rgba(59,130,246,0.1)"><div style="display:flex;align-items:center"><div class="avatar" style="background:#3b82f6">Y</div>You</div><div>üíé ${currentBet}</div></div>` + l.innerHTML;
        }
    </script>
</body>
</html>
